// Contract Management - Prisma Schema
// Supports: Auth, Contracts, Suppliers, Documents, Versions, Clauses, Obligations, Activity

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ---- Auth (NextAuth compatible) ----
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  passwordHash  String?   // For credentials provider
  image         String?
  role          UserRole  @default(ReadOnly)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]
  activityEvents ActivityEvent[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  Admin
  Legal
  Procurement
  ReadOnly
}

// ---- Suppliers ----
model Supplier {
  id             String     @id @default(cuid())
  name           String
  industry       String?
  spendEstimate  Float      @default(0)
  riskTrend      String?    // improving, stable, declining
  primaryContact String?
  email          String?
  location       String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  contracts      Contract[]

  @@index([name])
}

// ---- Contracts ----
model Contract {
  id             String         @id @default(cuid())
  supplierId     String
  supplier       Supplier       @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  contractName   String
  contractType   ContractType
  effectiveDate  DateTime
  expiryDate     DateTime
  status         ContractStatus @default(active)
  riskScore      Int            @default(0)
  riskLevel      RiskLevel      @default(low)
  value          Float          @default(0)
  tags           Json           @default("[]")
  uploadedAt     DateTime       @default(now())
  lastAnalyzedAt DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  documents      ContractDocument[]
  activityEvents ActivityEvent[]

  @@index([supplierId])
  @@index([contractName])
  @@index([contractType])
  @@index([status])
  @@index([riskLevel])
  @@index([expiryDate])
  @@index([uploadedAt])
}

enum ContractType {
  MSA
  SOW
  SLA
  NDA
  License
  Amendment
}

enum ContractStatus {
  active
  expiring
  expired
  draft
  under_review
}

enum RiskLevel {
  low
  medium
  high
  critical
}

// ---- Documents & Versions ----
model ContractDocument {
  id         String           @id @default(cuid())
  contractId String
  contract   Contract         @relation(fields: [contractId], references: [id], onDelete: Cascade)
  storagePath String          // Local: ./uploads/xxx or S3 key
  filename   String
  mimeType   String           @default("application/pdf")
  size       Int              // bytes
  checksum   String?          // SHA-256 hash
  createdAt  DateTime         @default(now())
  versions   ContractVersion[]

  @@index([contractId])
}

model ContractVersion {
  id             String            @id @default(cuid())
  documentId     String
  document       ContractDocument  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  versionNumber  Int               @default(1)
  processingStatus ProcessingStatus @default(PENDING)
  extractedText  String?
  extractedData  Json?             // Flexible: renewalTerms, paymentTerms, deliverables, etc.
  createdAt      DateTime         @default(now())
  clauses        Clause[]
  obligations    Obligation[]

  @@unique([documentId, versionNumber])
  @@index([documentId])
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

// ---- Clauses (from extraction) ----
model Clause {
  id            String         @id @default(cuid())
  versionId     String
  version       ContractVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  name          String
  category      String
  extractedText String
  interpretation String?
  riskNotes     String?
  pageRef       String?
  sortOrder     Int            @default(0)
  createdAt     DateTime       @default(now())

  @@index([versionId])
}

// ---- Obligations (from extraction) ----
model Obligation {
  id           String           @id @default(cuid())
  versionId    String
  version      ContractVersion  @relation(fields: [versionId], references: [id], onDelete: Cascade)
  obligation   String
  owner        ObligationOwner
  dueDate      DateTime?
  status       ObligationStatus @default(pending)
  evidenceLink String?
  sortOrder    Int              @default(0)
  createdAt    DateTime         @default(now())

  @@index([versionId])
}

enum ObligationOwner {
  Supplier
  Client
  Both
}

enum ObligationStatus {
  pending
  completed
  overdue
  at_risk
}

// ---- Activity Timeline ----
model ActivityEvent {
  id         String        @id @default(cuid())
  contractId String
  contract   Contract      @relation(fields: [contractId], references: [id], onDelete: Cascade)
  userId     String?
  user       User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     ActivityAction
  details    String
  metadata   Json?         // Optional extra data
  createdAt  DateTime      @default(now())

  @@index([contractId])
  @@index([createdAt])
}

enum ActivityAction {
  uploaded
  extracted
  insights_generated
  agent_draft
  reviewed
  compared
  status_change
  risk_updated
  version_added
}
